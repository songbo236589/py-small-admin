# 数据库迁移使用文档

## 概述

本项目使用 Alembic 作为数据库迁移工具，支持多模块独立的数据库迁移管理。每个模块都有自己独立的迁移系统，可以独立管理和执行数据库变更。

## 功能特性

- 支持多模块独立的数据库迁移管理
- 自动生成迁移文件
- 支持迁移升级和降级
- 提供完整的命令行接口
- 支持迁移历史查看和状态检查

## 安装依赖

项目所需的主要依赖已在 requirements.txt 中定义，确保已安装以下相关依赖包：

```bash
pip install -r requirements.txt
```

主要相关依赖包括：

- `alembic==1.17.2` - SQLAlchemy 的数据库迁移工具
- `sqlmodel==0.0.27` - 基于 Pydantic 和 SQLAlchemy 的现代 ORM
- `mysqlclient==2.2.7` - MySQL数据库客户端库
- `aiomysql==0.3.2` - 异步MySQL驱动
- `loguru==0.7.3` - 现代化的Python日志库

## 使用方法

### 1. 初始化模块迁移系统

为新模块初始化迁移系统：

```bash
python -m commands.migrate init --module admin
```

这将创建以下目录结构：

```
Modules/example/
├── migrations/
│   ├── __init__.py
│   ├── alembic.ini
│   ├── env.py
│   ├── script.py.mako
│   └── versions/
│       └── __init__.py
```

### 2. 创建迁移文件

为模块创建新的迁移文件：

```bash
python -m commands.migrate create --module admin --message "admin数据表"
```

这将自动生成迁移文件，文件名格式为：`YYYYMMDD_HHMM_revision_slug.py`

### 3. 执行迁移升级

升级指定模块到最新版本：

```bash
python -m commands.migrate up --module admin
```

升级所有模块到最新版本：

```bash
python -m commands.migrate up
```

升级到指定版本：

```bash
python -m commands.migrate up --module example --revision 20231201_1200_abc123
```

### 4. 执行迁移降级

降级指定模块一个版本：

```bash
python -m commands.migrate down --module example
```

降级到指定版本：

```bash
python -m commands.migrate down --module example --revision 20231101_1000_def456
```

### 5. 查看模块状态

列出所有模块及其迁移状态：

```bash
python -m commands.migrate list
```

输出示例：

```
发现的模块:
------------------------------------------------------------
模块名称              迁移状态         当前版本
------------------------------------------------------------
admin                 已初始化         abc12345
example               已初始化         def67890
test                  未初始化         -
------------------------------------------------------------
```

### 6. 查看迁移历史

查看指定模块的迁移历史：

```bash
python -m commands.migrate history --module example
```

### 7. 查看当前版本

查看指定模块的当前版本：

```bash
python -m commands.migrate current --module example
```

### 8. 验证模块迁移系统

验证模块迁移系统是否正确配置：

```bash
python -m commands.migrate validate --module example
```

## 模块结构要求

为了使迁移工具正常工作，模块需要满足以下结构要求：

```
Modules/模块名/
├── models/
│   ├── __init__.py
│   └── model_file.py
└── migrations/
    ├── __init__.py
    ├── alembic.ini
    ├── env.py
    ├── script.py.mako
    └── versions/
        └── __init__.py
```

## 模型定义规范

模型类需要继承自 `BaseModel`：

```python
from Modules.common.models.base_model import BaseModel
from sqlalchemy import Column, Integer, String

class ExampleModel(BaseModel):
    __tablename__ = "example_table"
  
    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False)
```

## 配置说明

### 数据库配置

数据库配置在配置文件中设置：

```python
# config/database.py
database = {
    "default": "mysql",
    "connections": {
        "mysql": {
            "host": "127.0.0.1",
            "port": 3306,
            "database": "forge",
            "username": "forge",
            "password": "",
            "charset": "utf8mb4"
        }
    }
}
```

### Alembic 配置

每个模块的 `migrations/alembic.ini` 文件会自动生成，包含以下主要配置：

```ini
[alembic]
script_location = .
file_template = %(year)d%(month).2d%(day).2d_%(hour).2d%(minute).2d_%(rev)s_%(slug)s
version_path_separator = os
sqlalchemy.url = mysql+pymysql://user:pass@host:port/database
```

## 最佳实践

### 1. 迁移文件命名

- 使用描述性的消息
- 遵循统一的命名规范
- 避免使用特殊字符

### 2. 迁移内容

- 每个迁移文件应该只包含一个逻辑变更
- 避免在迁移中包含数据操作（除非必要）
- 确保迁移可以安全地回滚

### 3. 团队协作

- 在合并代码前确保迁移文件已生成
- 定期同步数据库结构
- 保持迁移文件的顺序性

### 4. 生产环境

- 在生产环境执行迁移前先备份数据库
- 在低峰期执行迁移操作
- 测试迁移的回滚操作

## 常见问题

### 1. 迁移失败

如果迁移失败，请检查：

- 数据库连接是否正常
- 模型定义是否正确
- 迁移文件语法是否有误

### 2. 版本冲突

如果遇到版本冲突，可以：

- 使用 `history` 命令查看迁移历史
- 使用 `down` 命令回滚到冲突前的版本
- 手动解决冲突后重新生成迁移

### 3. 模块未发现

如果模块未被发现，请检查：

- 模块目录结构是否正确
- `models` 目录是否存在
- `__init__.py` 文件是否存在

## 命令参考


| 命令       | 参数                                         | 说明               |
| ---------- | -------------------------------------------- | ------------------ |
| `init`     | `--module/-m`                                | 初始化模块迁移系统 |
| `create`   | `--module/-m`, `--message/-msg`              | 创建迁移文件       |
| `up`       | `--module/-m` (可选), `--revision/-r` (可选) | 执行迁移升级       |
| `down`     | `--module/-m`, `--revision/-r` (可选)        | 执行迁移降级       |
| `list`     | 无                                           | 列出所有模块状态   |
| `history`  | `--module/-m`                                | 查看迁移历史       |
| `current`  | `--module/-m`                                | 查看当前版本       |
| `validate` | `--module/-m`                                | 验证模块迁移系统   |

## 示例工作流

### 新模块开发流程

1. 创建模块目录结构
2. 定义数据模型
3. 初始化迁移系统：
   ```bash
   python -m commands.migrate init --module new_module
   ```
4. 创建迁移文件：
   ```bash
   python -m commands.migrate create --module new_module --message "创建基础表结构"
   ```
5. 执行迁移：
   ```bash
   python -m commands.migrate up --module new_module
   ```

### 现有模块更新流程

1. 修改数据模型
2. 创建迁移文件：
   ```bash
   python -m commands.migrate create --module existing_module --message "添加新字段"
   ```
3. 执行迁移：
   ```bash
   python -m commands.migrate up --module existing_module
   ```
4. 验证结果：
   ```bash
   python -m commands.migrate current --module existing_module
   ```

## 注意事项

1. 确保在项目根目录下运行迁移命令
2. 迁移操作会修改数据库结构，请谨慎操作
3. 在生产环境执行迁移前务必备份数据库
4. 定期检查迁移状态，确保数据库结构同步
5. 避免直接修改数据库结构，始终使用迁移工具
