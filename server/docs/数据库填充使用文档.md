# 数据库填充使用文档

## 概述

数据库填充（Seeding）是指在数据库中插入初始数据或测试数据的过程。本项目提供了完整的数据库填充系统，支持模块化的种子数据管理，允许每个模块独立管理自己的种子数据。

## 架构设计

### 核心组件

1. **种子数据命令行工具** (`commands/seed.py`)
   - 提供完整的种子数据命令行接口
   - 支持模块级别和全局种子数据操作
   - 提供种子数据状态查询和验证功能

2. **模块发现器** (`commands/seed.py`中的`ModuleDiscovery`类)
   - 自动发现项目中的所有模块
   - 识别模块的种子数据文件
   - 提供模块信息查询接口

## 目录结构

### 种子数据目录结构

```
server/Modules/{module_name}/
├── __init__.py              # 模块初始化文件
├── models/                  # 模型目录
│   ├── __init__.py
│   └── model_name.py        # 模型文件
├── migrations/              # 迁移目录
│   └── ...
└── seeds/                   # 数据填充目录
    ├── __init__.py          # 入口文件，定义run_seeds函数
    └── {name}_seed.py       # 种子数据文件
```

### 种子数据文件结构

种子数据文件应遵循以下命名规范：
- 格式：`{name}_seed.py`
- 示例：`admin_seed.py`, `users_seed.py`, `products_seed.py`

## 使用指南

### 1. 创建种子数据文件

在模块的 `seeds/` 目录下创建种子数据文件，例如 `admin_seed.py`：

```python
"""
Admin 模块种子数据
"""

from datetime import datetime
from Modules.admin.models.admin_admin import AdminAdmin
from Modules.common.libs.database.sql.session import db_session_manager
from Modules.common.libs.password.password import PasswordService

def seed_admin_data():
    """种子数据示例"""
    print("正在生成Admin模块的种子数据...")
    
    # 初始化数据库会话
    db_session_manager.init_session_maker()
    
    # 获取同步会话生成器
    session_gen = db_session_manager.get_sync_session()
    # 使用next()获取会话
    session = next(session_gen)
    try:
        # 检查数据是否已存在
        existing = session.query(AdminAdmin).filter_by(username="admin").first()
        if existing:
            print("管理员账号已存在，跳过创建")
            return
        
        # 密码管理器
        password_service = PasswordService()
        hashed_password = password_service.hash_password("admin123")
        
        # 创建新数据
        admin = AdminAdmin(
            name="超级管理员",
            username="admin",
            password=hashed_password,
            phone="13800138000",
            status=1,
            created_at=datetime.now(),
            updated_at=datetime.now()
        )
        session.add(admin)
        session.commit()
        
    finally:
        # 确保会话被正确关闭
        session.close()
    
    print("✅ Admin模块种子数据生成完成!")


if __name__ == "__main__":
    seed_admin_data()
```

### 2. 创建种子数据入口文件

在模块的 `seeds/__init__.py` 文件中添加 `run_seeds` 函数：

```python
"""
Admin 模块种子数据入口
"""

def run_seeds(env='development'):
    """运行所有种子数据"""
    from .admin_seed import seed_admin_data
    
    # 根据环境执行不同的种子数据
    if env == 'development':
        # 开发环境：创建完整的测试数据
        seed_admin_data()
    elif env == 'production':
        # 生产环境：只创建必要的初始数据
        seed_admin_data()
    elif env == 'test':
        # 测试环境：创建特定的测试数据
        seed_admin_data()
```

### 3. 运行种子数据

#### 运行指定模块的种子数据
```bash
python -m commands.seed run --module {module_name}
```

示例：
```bash
python -m commands.seed run --module admin
```

或者使用简写：
```bash
python -m commands.seed run -m admin
```

#### 运行所有模块的种子数据
```bash
python -m commands.seed run-all
```

#### 指定环境运行种子数据
```bash
python -m commands.seed run --module admin --env production
```

### 4. 查看种子数据状态

#### 列出所有模块的种子数据状态
```bash
python -m commands.seed list
```

输出示例：
```
模块填充状态:
--------------------------------------------------------------------------------
  admin: 有填充, 有效, 3 模型, 1 种子文件
  user: 有填充, 有效, 2 模型, 2 种子文件
  product: 无填充, 3 模型, 0 种子文件
--------------------------------------------------------------------------------
```

### 5. 验证种子数据

#### 验证指定模块的种子数据
```bash
python -m commands.seed validate --module {module_name}
```

示例：
```bash
python -m commands.seed validate --module admin
```

输出示例：
```
模块 admin 填充验证:
  种子文件: 1
  - admin_seed
✓ 验证通过
```

### 6. 模拟运行种子数据

#### 模拟运行指定模块的种子数据（不实际执行）
```bash
python -m commands.seed dry-run --module {module_name}
```

示例：
```bash
python -m commands.seed dry-run --module admin
```

输出示例：
```
模拟运行模块 admin 的数据填充 (环境: development):
  将执行: admin_seed
模拟运行完成
```

## 种子数据最佳实践

### 1. 环境区分

建议根据不同环境创建不同的种子数据：

```python
def run_seeds(env='development'):
    """运行所有种子数据"""
    if env == 'development':
        # 开发环境：创建完整的测试数据
        seed_admin_examples()
        seed_test_users()
        seed_sample_data()
    elif env == 'production':
        # 生产环境：只创建必要的初始数据
        seed_admin_examples()
        seed_system_settings()
    elif env == 'test':
        # 测试环境：创建特定的测试数据
        seed_test_users()
        seed_test_data()
```

### 2. 数据依赖处理

处理种子数据之间的依赖关系：

```python
def seed_users():
    """创建用户数据"""
    # 先创建用户
    pass

def seed_orders():
    """创建订单数据（依赖于用户）"""
    # 确保用户已创建
    seed_users()
    # 然后创建订单
    pass

def run_seeds(env='development'):
    """按依赖顺序运行种子数据"""
    seed_users()
    seed_orders()
```

### 3. 数据幂等性

确保种子数据可以重复运行而不会产生重复数据：

```python
def seed_admin_examples():
    """种子数据示例"""
    from Modules.admin.models.example import AdminExample
    from Modules.common.libs.database.sql.session import db_session_manager
    
    # 初始化数据库会话
    db_session_manager.init_session_maker()
    
    # 获取同步会话生成器
    session_gen = db_session_manager.get_sync_session()
    # 使用next()获取会话
    session = next(session_gen)
    try:
        # 检查数据是否已存在
        existing = session.query(AdminExample).filter_by(name="示例数据").first()
        if existing:
            print("示例数据已存在，跳过创建")
            return
        
        # 创建新数据
        example = AdminExample(
            name="示例数据",
            description="这是一个示例数据"
        )
        session.add(example)
        session.commit()
        
    finally:
        # 确保会话被正确关闭
        session.close()
    
    print("✅ Admin模块种子数据生成完成!")
```

### 4. 批量数据创建

对于大量数据，使用批量插入提高性能：

```python
def seed_large_dataset():
    """创建大量测试数据"""
    from Modules.admin.models.example import AdminExample
    from Modules.common.libs.database.sql.session import db_session_manager
    
    # 初始化数据库会话
    db_session_manager.init_session_maker()
    
    # 获取同步会话生成器
    session_gen = db_session_manager.get_sync_session()
    # 使用next()获取会话
    session = next(session_gen)
    try:
        # 准备数据
        data_list = []
        for i in range(1000):
            data_list.append(AdminExample(
                name=f"示例数据 {i}",
                description=f"这是第 {i} 个示例数据"
            ))
        
        # 批量插入
        session.add_all(data_list)
        session.commit()
        
    finally:
        # 确保会话被正确关闭
        session.close()
    
    print(f"✅ 创建了 {len(data_list)} 条示例数据!")
```

## 常见问题与解决方案

### 1. 种子数据运行失败

**问题**：运行种子数据时出现错误

**解决方案**：
1. 检查数据库连接是否正常
2. 确认模型文件已正确导入
3. 检查种子数据文件语法是否正确
4. 使用 `validate` 命令验证种子数据结构

```bash
python -m commands.seed validate --module your_module
```

### 2. 依赖模块未找到

**问题**：导入模型时出现模块未找到错误

**解决方案**：
1. 确认模型文件路径正确
2. 检查 `__init__.py` 文件是否存在
3. 确保相对导入路径正确

```python
# 正确的导入方式
from Modules.admin.models.admin_admin import AdminAdmin
# 或者
from Modules.{module_name}.models.example import ExampleModel
```

### 3. 数据重复创建

**问题**：重复运行种子数据导致数据重复

**解决方案**：
1. 在创建数据前检查是否已存在
2. 使用唯一约束防止重复
3. 考虑使用 `get_or_create` 模式

```python
def get_or_create(session, model, defaults=None, **kwargs):
    """获取或创建记录"""
    instance = session.query(model).filter_by(**kwargs).first()
    if instance:
        return instance, False
    else:
        params = dict((k, v) for k, v in kwargs.items())
        params.update(defaults or {})
        instance = model(**params)
        session.add(instance)
        session.commit()
        return instance, True
```

### 4. 种子数据顺序问题

**问题**：种子数据之间的依赖关系导致运行失败

**解决方案**：
1. 在 `run_seeds` 函数中按正确顺序调用种子函数
2. 使用 `dry-run` 命令检查执行顺序
3. 考虑将依赖数据放在同一个种子文件中

## 高级用法

### 1. 条件种子数据

根据条件决定是否创建某些数据：

```python
def seed_admin_examples():
    """种子数据示例"""
    from Modules.admin.models.example import AdminExample
    from Modules.common.libs.database.sql.session import db_session_manager
    
    # 初始化数据库会话
    db_session_manager.init_session_maker()
    
    # 获取同步会话生成器
    session_gen = db_session_manager.get_sync_session()
    # 使用next()获取会话
    session = next(session_gen)
    try:
        # 检查是否已有数据
        count = session.query(AdminExample).count()
        
        if count == 0:
            # 没有数据时创建示例数据
            example = AdminExample(
                name="示例数据",
                description="这是一个示例数据"
            )
            session.add(example)
            session.commit()
            print("✅ 创建示例数据")
        elif count < 10:
            # 数据较少时补充一些数据
            for i in range(count, 10):
                example = AdminExample(
                    name=f"补充数据 {i}",
                    description=f"这是第 {i} 个补充数据"
                )
                session.add(example)
            session.commit()
            print(f"✅ 补充了 {10 - count} 条数据")
        else:
            print("已有足够数据，跳过创建")
            
    finally:
        # 确保会话被正确关闭
        session.close()
```

### 2. 动态种子数据

根据配置或其他动态因素生成种子数据：

```python
def seed_dynamic_data():
    """动态生成种子数据"""
    from Modules.admin.models.example import AdminExample
    from Modules.common.libs.database.sql.session import db_session_manager
    import random
    
    # 从配置或其他地方获取参数
    data_count = 10  # 可以从配置文件读取
    
    # 初始化数据库会话
    db_session_manager.init_session_maker()
    
    # 获取同步会话生成器
    session_gen = db_session_manager.get_sync_session()
    # 使用next()获取会话
    session = next(session_gen)
    try:
        for i in range(data_count):
            example = AdminExample(
                name=f"动态数据 {i}",
                description=f"这是随机生成的数据 {random.randint(1000, 9999)}"
            )
            session.add(example)
        
        session.commit()
        
    finally:
        # 确保会话被正确关闭
        session.close()
    
    print(f"✅ 动态创建了 {data_count} 条数据!")
```

### 3. 外部数据源

从外部文件或API获取数据作为种子数据：

```python
def seed_from_json():
    """从JSON文件加载种子数据"""
    import json
    from Modules.admin.models.example import AdminExample
    from Modules.common.libs.database.sql.session import db_session_manager
    
    # 读取JSON文件
    with open('seed_data.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # 初始化数据库会话
    db_session_manager.init_session_maker()
    
    # 获取同步会话生成器
    session_gen = db_session_manager.get_sync_session()
    # 使用next()获取会话
    session = next(session_gen)
    try:
        for item in data:
            example = AdminExample(
                name=item['name'],
                description=item['description']
            )
            session.add(example)
        
        session.commit()
        
    finally:
        # 确保会话被正确关闭
        session.close()
    
    print(f"✅ 从JSON文件加载了 {len(data)} 条数据!")
```

## 命令参考

### 完整命令列表

| 命令 | 简写 | 描述 | 示例 |
|------|------|------|------|
| `run --module <name>` | `run -m <name>` | 运行指定模块的种子数据 | `python -m commands.seed run -m admin` |
| `run-all` | 无 | 运行所有模块的种子数据 | `python -m commands.seed run-all` |
| `list` | 无 | 列出所有模块的种子数据状态 | `python -m commands.seed list` |
| `validate --module <name>` | `validate -m <name>` | 验证指定模块的种子数据 | `python -m commands.seed validate -m admin` |
| `dry-run --module <name>` | `dry-run -m <name>` | 模拟运行种子数据 | `python -m commands.seed dry-run -m admin` |

### 全局选项

| 选项 | 描述 | 默认值 |
|------|------|--------|
| `--module, -m` | 指定模块名称 | 必需 |
| `--env` | 指定环境名称 | development |

## 注意事项

1. **数据备份**：在生产环境运行种子数据前，务必备份数据库
2. **幂等性**：确保种子数据可以重复运行而不会产生错误
3. **性能考虑**：大量数据插入时考虑使用批量操作
4. **环境隔离**：不同环境使用不同的种子数据策略
5. **版本控制**：将种子数据文件纳入版本控制
6. **文档更新**：更新种子数据后及时更新相关文档

## 相关文件

- `commands/seed.py` - 种子数据命令行工具
- `Modules/admin/seeds/` - 示例种子数据文件
- `Modules/common/libs/database/sql/session.py` - 数据库会话管理
- `Modules/common/models/base_model.py` - 基础模型类