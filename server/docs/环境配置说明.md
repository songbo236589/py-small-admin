# 环境配置说明

## 概述

项目已优化环境配置文件结构，从原来的6个env文件简化为2个示例配置文件，提高了配置管理的可维护性和安全性。

## 配置文件结构

```
server/
├── .env.example                    # 开发环境示例配置（提交到版本控制）
├── .env.production.example          # 生产环境示例配置（提交到版本控制）
├── .env                          # 实际开发环境配置（不提交到版本控制）
├── .env.production               # 实际生产环境配置（不提交到版本控制）
├── .gitignore                     # 忽略实际配置文件
└── docker/
    ├── docker-compose.yml          # 开发环境Docker配置
    └── docker-compose.prod.yml     # 生产环境Docker配置
```

## 配置文件说明

### 1. `.env.example` - 开发环境示例配置

- **用途**：开发环境的配置模板
- **状态**：已提交到版本控制
- **特点**：
  - 包含所有必要的配置项
  - 敏感信息使用占位符（如 `CHANGE_THIS_TO_STRONG_KEY`）
  - 适合本地开发和测试

### 2. `.env.production.example` - 生产环境示例配置

- **用途**：生产环境的配置模板
- **状态**：已提交到版本控制
- **特点**：
  - 包含生产环境特定的配置
  - 敏感信息使用占位符（如 `CHANGE_THIS_TO_VERY_STRONG_SECRET_KEY`）
  - 包含安全最佳实践建议

### 3. `.env` - 实际开发环境配置

- **用途**：实际开发环境的配置文件
- **状态**：不提交到版本控制（在 `.gitignore` 中）
- **创建方法**：
  ```bash
  cp .env.example .env
  ```
- **注意事项**：
  - 不要将此文件提交到版本控制系统
  - 根据实际情况修改配置项
  - 特别注意修改密码、密钥等敏感信息

### 4. `.env.production` - 实际生产环境配置

- **用途**：实际生产环境的配置文件
- **状态**：不提交到版本控制（在 `.gitignore` 中）
- **创建方法**：
  ```bash
  cp .env.production.example .env.production
  ```
- **注意事项**：
  - 不要将此文件提交到版本控制系统
  - 根据生产环境需求修改配置项
  - 务必使用强密码和密钥
  - 关闭调试模式（`APP_DEBUG=false`）
  - 限制API文档访问（`APP_DOCS_ENABLED=false`）

## 使用方法

### 开发环境

1. **创建配置文件**：
   ```bash
   cp .env.example .env
   ```

2. **修改配置**：
   - 编辑 `.env` 文件
   - 修改数据库连接信息
   - 修改Redis连接信息
   - 修改JWT密钥等敏感信息

3. **启动应用**：
   ```bash
   # 本地开发
   python run.py

   # Docker开发环境
   cd docker
   docker-compose up -d
   ```

### 生产环境

1. **创建配置文件**：
   ```bash
   cp .env.production.example .env.production
   ```

2. **修改配置**：
   - 编辑 `.env.production` 文件
   - **必须**修改所有占位符为实际值
   - 使用强密码和密钥
   - 配置生产环境的数据库和Redis连接
   - 配置云存储服务（如阿里云OSS、腾讯云COS等）

3. **启动应用**：
   ```bash
   cd docker
   docker-compose -f docker-compose.prod.yml up -d
   ```

## 重要配置项说明

### 敏感信息配置

以下配置项在生产环境中必须修改：

1. **数据库密码**：
   ```env
   DB_CONNECTIONS__MYSQL__PASSWORD=your_strong_mysql_password
   DB_REDIS__DEFAULT__USERNAME=default
   DB_REDIS__DEFAULT__PASSWORD=your_strong_redis_password
   DB_REDIS__CACHE__USERNAME=default
   DB_REDIS__CACHE__PASSWORD=your_strong_redis_password
   ```

2. **JWT密钥**：
   ```env
   JWT_SECRET_KEY=your_very_long_and_secure_secret_key_at_least_32_characters
   ```

3. **管理员账号**：
   ```env
   APP_DEFAULT_ADMIN_USERNAME=admin
   APP_DEFAULT_ADMIN_PASSWORD=your_strong_admin_password
   ```

4. **RabbitMQ密码**：
   ```env
   CELERY_BROKER_URL=amqp://admin:your_strong_rabbitmq_password@localhost:5672//
   ```

5. **Flower认证**：
   ```env
   CELERY_FLOWER_BASIC_AUTH=admin:your_strong_flower_password
   ```

### 安全配置建议

生产环境建议的安全配置：

1. **关闭调试模式**：
   ```env
   APP_DEBUG=false
   ```

2. **关闭API文档**：
   ```env
   APP_DOCS_ENABLED=false
   ```

3. **限制CORS来源**：
   ```env
   APP_CORS_ALLOW_ALL=false
   APP_CORS_ORIGINS=["https://yourdomain.com"]
   ```

4. **提高日志级别**：
   ```env
   LOG_LEVEL=WARNING
   ```

5. **使用SSL连接**：
   ```env
   CELERY_BROKER_USE_SSL=true
   ```

6. **配置Redis用户名（Redis 6.0+ ACL功能）**：
   ```env
   DB_REDIS__DEFAULT__USERNAME=default
   DB_REDIS__CACHE__USERNAME=default
   CELERY_RESULT_BACKEND="redis://default:password@host:port/database"
   ```

**说明**：
- Redis 6.0+版本支持ACL（Access Control List）功能，可以使用用户名和密码认证
- 默认用户名是 `default`，可以根据需要修改
- 如果不配置用户名，Redis会使用默认用户
- 开发环境可以使用默认用户，生产环境建议创建专用用户

## 配置文件变更历史

### 优化前

- `.env` (764行) - 根目录实际配置
- `.env.example` (762行) - 根目录示例配置
- `docker/.env` (433行) - Docker开发环境实际配置
- `docker/.env.example` (438行) - Docker开发环境示例配置
- `docker/.env.production` (446行) - Docker生产环境实际配置
- `docker/.env.production.example` (446行) - Docker生产环境示例配置

**问题**：
- 配置严重重复（约90%相似度）
- 文件数量过多（6个文件）
- 敏感信息暴露风险高
- 维护成本高

### 优化后

- `.env.example` - 开发环境示例配置
- `.env.production.example` - 生产环境示例配置
- `.env` - 实际开发环境配置（不提交）
- `.env.production` - 实际生产环境配置（不提交）

**优点**：
- 配置文件数量减少（从6个减少到2个示例文件）
- 配置集中管理
- 敏感信息得到保护
- 维护成本降低
- 符合最佳实践

## Docker Compose 配置

### 开发环境 (`docker/docker-compose.yml`)

- 引用根目录的 `.env` 文件
- 适合本地开发和测试
- 暴露所有服务端口到主机

### 生产环境 (`docker/docker-compose.prod.yml`)

- 引用根目录的 `.env.production` 文件
- 适合生产环境部署
- 不暴露数据库和Redis端口到主机
- 配置资源限制和日志管理

## 注意事项

1. **不要提交实际配置文件**：
   - `.env` 和 `.env.production` 文件已在 `.gitignore` 中
   - 确保不要意外提交这些文件

2. **使用强密码**：
   - 生产环境必须使用强密码
   - 定期更换密码
   - 使用密码管理工具

3. **定期审查配置**：
   - 定期检查配置项是否符合安全要求
   - 更新过期的配置
   - 删除不必要的配置项

4. **备份配置**：
   - 定期备份生产环境配置
   - 使用安全的存储方式
   - 不要将备份提交到版本控制

5. **使用环境变量**：
   - 对于特别敏感的信息，可以考虑使用环境变量
   - 或使用密钥管理服务（如AWS Secrets Manager、HashiCorp Vault等）

## 故障排查

### 配置文件未生效

1. 检查配置文件路径是否正确
2. 确认配置文件名称是否正确（`.env` vs `.env.production`）
3. 检查配置文件格式是否正确（不要有多余的引号或空格）

### Docker容器无法启动

1. 检查 `.env` 或 `.env.production` 文件是否存在
2. 确认配置文件中的数据库、Redis等连接信息是否正确
3. 查看Docker日志：`docker-compose logs -f [service_name]`

### 配置项不生效

1. 检查配置项名称是否正确
2. 确认配置项的值格式是否正确（字符串需要引号，数字不需要）
3. 重启应用使配置生效

## 相关文档

- [Python环境配置完整指南](./Python环境配置完整指南.md)
- [config使用文档](./config使用文档.md)
- [Docker安装Redis使用文档](./Docker安装Redis使用文档.md)
- [Celery+RabbitMQ使用文档](./Celery+RabbitMQ使用文档.md)

## 总结

通过优化env文件配置结构，我们实现了：

1. ✅ 减少配置文件数量（从6个减少到2个示例文件）
2. ✅ 提高配置管理的可维护性
3. ✅ 保护敏感信息安全
4. ✅ 符合最佳实践
5. ✅ 降低维护成本

新的配置结构更加清晰、安全、易于维护，为项目的持续开发和部署提供了良好的基础。
