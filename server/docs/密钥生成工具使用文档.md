# 密钥生成工具使用文档

## 概述

`generate_keys.py` 是一个用于生成和更新 `.env` 文件中安全密钥的命令行工具。它支持生成两种类型的密钥：
- `APP_ADMIN_X_API_KEY`: 管理员接口验证的API密钥
- `JWT_SECRET_KEY`: JWT认证密钥

## 功能特性

- 🔒 生成加密安全的随机密钥
- 📝 智能更新 `.env` 文件，保留原有格式和注释
- 👀 密钥遮蔽显示，保护敏感信息
- ✅ 用户确认机制，防止误操作
- 🧪 预览模式，查看将要生成的密钥
- 📏 支持自定义密钥长度
- 📁 支持指定环境文件路径

## 使用方法

### 基本用法

```bash
# 生成所有密钥（需要确认）
python -m commands.generate_keys --all

# 只生成API密钥
python -m commands.generate_keys --api-key

# 只生成JWT密钥
python -m commands.generate_keys --jwt-secret
```

### 高级用法

```bash
# 预览模式（不实际修改文件）
python -m commands.generate_keys --all --dry-run

# 跳过确认步骤（自动化脚本友好）
python -m commands.generate_keys --all --yes

# 自定义密钥长度
python -m commands.generate_keys --api-key --length 64

# 指定环境文件路径
python -m commands.generate_keys --all --env /path/to/.env
```

## 命令行参数

### 必选参数（三选一）

- `--all`: 生成所有密钥
- `--api-key`: 只生成API密钥
- `--jwt-secret`: 只生成JWT密钥

### 可选参数

- `--length LENGTH`: 密钥长度（API密钥默认32，JWT密钥默认64）
- `--dry-run`: 预览模式，不实际修改文件
- `--env ENV`: 指定.env文件路径
- `--yes, -y`: 跳过确认步骤，直接执行

## 安全特性

### 密钥生成

- 使用 `secrets` 模块生成加密安全的随机字符串
- API密钥：字母和数字组合，默认32位
- JWT密钥：字母和数字组合，默认64位，符合JWT安全要求

### 密钥验证

- JWT密钥自动验证复杂度（包含字母和数字）
- 密钥长度符合项目配置要求

### 信息保护

- 显示时自动遮蔽密钥，只显示前4位和后4位
- 支持预览模式，查看但不修改文件

## 示例输出

```bash
$ python -m commands.generate_keys --api-key --dry-run

将要生成的密钥:
--------------------------------------------------
配置项: APP_ADMIN_X_API_KEY
当前值: ******
新值:   7wii************************zPBB
长度:   32
--------------------------------------------------

预览模式，未实际修改文件
```

## 注意事项

1. **备份重要**: 虽然工具很安全，但建议在修改生产环境配置前备份 `.env` 文件
2. **权限管理**: 确保有足够的权限读取和写入 `.env` 文件
3. **密钥安全**: 生成的密钥请妥善保管，不要提交到版本控制系统
4. **服务重启**: 更新密钥后需要重启相关服务才能生效

## 故障排除

### 常见错误

1. **文件不存在**: 确保 `.env` 文件存在或使用 `--env` 参数指定正确路径
2. **权限不足**: 确保有读写权限
3. **编码问题**: 工具使用UTF-8编码，确保 `.env` 文件也是UTF-8编码

### 调试技巧

使用 `--dry-run` 参数可以预览将要执行的操作，避免意外修改。

## 集成到CI/CD

在自动化脚本中，可以使用 `--yes` 参数跳过交互确认：

```bash
#!/bin/bash
# 生成新的密钥并更新配置
python -m commands.generate_keys --all --yes

# 重启服务
systemctl restart your-service