# ===================================================================
# Redis 配置文件 - Py Small Admin
# ===================================================================
# 说明:
# - 此配置文件用于优化Redis性能和功能
# - 适用于Docker环境的Redis 7.x
# - 可根据实际需求调整配置参数
# ===================================================================

# ===================================================================
# 网络配置
# ===================================================================

# 绑定地址（0.0.0.0 表示监听所有网络接口）
bind 0.0.0.0

# 监听端口
port 6379

# 保护模式（设置为no，因为已经设置了密码）
protected-mode no

# TCP 监听队列长度
tcp-backlog 511

# TCP keepalive 时间（秒）
tcp-keepalive 300

# ===================================================================
# 通用配置
# ===================================================================

# 以守护进程方式运行（Docker环境下设置为no）
daemonize no

# 进程ID文件
pidfile /var/run/redis.pid

# 日志级别
# debug: 详细调试信息
# verbose: 详细信息
# notice: 适中信息（推荐）
# warning: 仅警告和错误
loglevel notice

# 日志文件（Docker环境下输出到标准输出，不使用文件）
logfile ""

# 数据库数量
databases 16

# ===================================================================
# 快照（RDB）配置
# ===================================================================

# RDB 文件名
dbfilename dump.rdb

# RDB 文件存储目录
dir /data

# 保存策略（多条件满足即触发）
# 900秒内至少有1个key变化
save 900 1
# 300秒内至少有10个key变化
save 300 10
# 60秒内至少有10000个key变化
save 60 10000

# 如果保存出错，是否停止写入
stop-writes-on-bgsave-error yes

# 是否压缩RDB文件
rdbcompression yes

# RDB文件校验
rdbchecksum yes

# ===================================================================
# 追加文件（AOF）配置
# ===================================================================

# 启用AOF持久化
appendonly yes

# AOF文件名
appendfilename "appendonly.aof"

# AOF刷盘策略
# always: 每次写入都刷盘（最安全，性能最差）
# everysec: 每秒刷盘（推荐，平衡性能和安全）
# no: 由操作系统决定刷盘（性能最好，可能丢失数据）
appendfsync everysec

# AOF重写时是否同步
no-appendfsync-on-rewrite no

# AOF重写触发条件
# AOF文件大小比上次重写后增长100%
auto-aof-rewrite-percentage 100
# AOF文件至少达到64MB才触发重写
auto-aof-rewrite-min-size 64mb

# AOF文件加载时是否截断
aof-load-truncated yes

# ===================================================================
# 内存配置
# ===================================================================

# 最大内存限制（根据服务器内存调整）
# 开发环境: 512mb
# 生产环境: 根据服务器内存调整（如 1gb, 2gb, 4gb）
maxmemory 512mb

# 内存淘汰策略
# allkeys-lru: 删除最少使用的key（推荐）
# volatile-lru: 删除设置了过期时间的最少使用的key
# allkeys-random: 随机删除key
# volatile-random: 随机删除设置了过期时间的key
# volatile-ttl: 删除即将过期的key
# noeviction: 不删除key，内存满时返回错误
maxmemory-policy allkeys-lru

# 内存淘汰算法样本数量
maxmemory-samples 5

# ===================================================================
# 慢查询日志
# ===================================================================

# 慢查询阈值（微秒）
slowlog-log-slower-than 10000

# 慢查询日志最大长度
slowlog-max-len 128

# ===================================================================
# 延迟监控
# ===================================================================

# 延迟监控阈值（毫秒）
latency-monitor-threshold 100

# ===================================================================
# 密码认证
# ===================================================================

# 访问密码（生产环境必须设置强密码）
requirepass redis123456

# ===================================================================
# 客户端配置
# ===================================================================

# 最大客户端连接数
maxclients 10000

# 客户端空闲超时时间（秒，0表示不超时）
timeout 0

# TCP keepalive 时间（秒）
tcp-keepalive 300

# ===================================================================
# 安全配置
# ===================================================================

# 禁用危险命令（根据需要调整）
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""
# rename-command DEBUG ""
# rename-command SHUTDOWN ""

# ===================================================================
# 主从复制配置（如需主从复制，取消注释以下配置）
# ===================================================================

# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-disable-tcp-nodelay no
# replica-priority 100

# ===================================================================
# 集群配置（如需Redis集群，取消注释以下配置）
# ===================================================================

# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes

# ===================================================================
# 高级配置
# ===================================================================

# 哈希表大小
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表压缩
list-max-ziplist-size -2
list-compress-depth 0

# 集合压缩
set-max-intset-entries 512

# 有序集合压缩
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog
hll-sparse-max-bytes 3000

# 流配置
stream-node-max-bytes 4096
stream-node-max-entries 100

# 激进式rehash
activerehashing yes

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 查询频率限制
hz 10

# 动态hz
dynamic-hz yes

# AOF重写使用RDB前缀
aof-use-rdb-preamble yes

# ===================================================================
# 模块加载（如需加载Redis模块，取消注释以下配置）
# ===================================================================

# loadmodule /path/to/my_module.so

# ===================================================================
# 用户配置（Redis 6.0+ ACL功能）
# ===================================================================

# 用户定义
# user default on nopass ~* +@all
# user admin on +@all -@dangerous >admin_password

# ===================================================================
# 其他配置
# ===================================================================

# 是否启用Lua调试
lua-time-limit 5000

# 是否启用RDB-AOF混合持久化
# 开启后，AOF重写时使用RDB格式
rdb-save-incremental-fsync yes
