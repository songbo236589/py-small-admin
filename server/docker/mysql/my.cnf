# ===================================================================
# MySQL 配置文件 - Py Small Admin
# ===================================================================
# 说明:
# - 此配置文件用于优化MySQL性能和功能
# - 适用于Docker环境的MySQL 8.0
# - 可根据实际需求调整配置参数
# ===================================================================

[mysqld]
# ===================================================================
# 字符集和排序规则
# ===================================================================
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
init_connect='SET NAMES utf8mb4'

# ===================================================================
# 网络配置
# ===================================================================
# 监听所有网络接口
bind-address=0.0.0.0

# 最大连接数
max_connections=500

# 连接超时时间（秒）
wait_timeout=28800
interactive_timeout=28800

# ===================================================================
# InnoDB 配置
# ===================================================================
# InnoDB 缓冲池大小（建议设置为物理内存的50-70%）
# 开发环境: 512M
# 生产环境: 根据服务器内存调整（如 2G, 4G, 8G）
innodb_buffer_pool_size=512M

# InnoDB 日志文件大小
innodb_log_file_size=256M

# InnoDB 日志缓冲区大小
innodb_log_buffer_size=16M

# InnoDB 刷盘策略
# 1: 每秒刷盘（性能好，可能丢失1秒数据）
# 0: 不刷盘（性能最好，但可能丢失数据）
# 2: 每次事务提交刷盘（最安全，性能最差）
innodb_flush_log_at_trx_commit=1

# InnoDB 文件格式
innodb_file_per_table=1

# InnoDB 锁等待超时时间（秒）
innodb_lock_wait_timeout=50

# ===================================================================
# 查询缓存（MySQL 8.0 已移除查询缓存）
# ===================================================================

# ===================================================================
# 慢查询日志
# ===================================================================
# 启用慢查询日志
slow_query_log=1

# 慢查询日志文件路径
slow_query_log_file=/var/log/mysql/slow.log

# 慢查询阈值（秒）
long_query_time=2

# 记录未使用索引的查询
log_queries_not_using_indexes=0

# ===================================================================
# 二进制日志
# ===================================================================
# 启用二进制日志
log_bin=mysql-bin

# 二进制日志格式
# ROW: 行级（推荐，最安全）
# STATEMENT: 语句级
# MIXED: 混合模式
binlog_format=ROW

# 二进制日志过期天数
expire_logs_days=7

# 二进制日志缓存大小
binlog_cache_size=1M

# ===================================================================
# 错误日志
# ===================================================================
# 错误日志路径
log_error=/var/log/mysql/error.log

# 错误日志级别
# 1: 错误
# 2: 错误和警告
# 3: 错误、警告和信息
log_error_verbosity=2

# ===================================================================
# 通用查询日志（生产环境建议关闭）
# ===================================================================
general_log=0
general_log_file=/var/log/mysql/general.log

# ===================================================================
# 性能优化
# ===================================================================
# 表缓存
table_open_cache=2000

# 表定义缓存
table_definition_cache=1400

# 临时表大小
tmp_table_size=64M
max_heap_table_size=64M

# 排序缓冲区大小
sort_buffer_size=2M

# 连接缓冲区大小
read_buffer_size=2M
read_rnd_buffer_size=8M

# 连接缓冲区大小
join_buffer_size=2M

# MyISAM 键缓冲区（如果使用MyISAM引擎）
key_buffer_size=32M

# ===================================================================
# 安全配置
# ===================================================================
# 默认认证插件
default-authentication-plugin=mysql_native_password

# 禁用符号链接（安全考虑）
symbolic_links=0

# 本地导入文件路径限制
secure_file_priv=/var/lib/mysql-files

# ===================================================================
# 时区配置
# ===================================================================
default-time-zone='+08:00'

# ===================================================================
# SQL 模式
# ===================================================================
# 严格模式，提高数据完整性
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

# ===================================================================
# 其他配置
# ===================================================================
# 跳过域名解析（提高连接速度）
skip-name-resolve

# 自动提交
autocommit=1

# 最大允许的数据包大小（100MB，用于大文件上传）
max_allowed_packet=100M

# ===================================================================
# 复制配置（如需主从复制，取消注释以下配置）
# ===================================================================
# server-id=1
# log-bin=mysql-bin
# binlog-do-db=fastapi_db
# relay-log=relay-bin
# relay-log-index=relay-bin.index

# ===================================================================
# 客户端配置
# ===================================================================
[client]
default-character-set=utf8mb4

[mysql]
default-character-set=utf8mb4
