# 架构概览

本文档介绍 Py Small Admin 的整体架构设计和技术选型。

## 概述

Py Small Admin 是一个基于 FastAPI 的轻量级后台管理系统，采用现代化的分层架构设计，提供了完整的用户管理、权限控制、数据管理等功能。

## 技术栈

### 核心框架

- **FastAPI**: 现代、快速的 Web 框架
  - 自动生成 OpenAPI 文档
  - 类型提示支持
  - 异步支持
  - 高性能

- **SQLModel**: 基于 Pydantic 和 SQLAlchemy 的 ORM
  - 类型安全
  - Pydantic 验证
  - SQLAlchemy 功能
  - 易于使用

### 数据库

- **MySQL**: 主数据库
  - 关系型数据库
  - 事务支持
  - 成熟稳定

- **Redis**: 缓存和会话存储
  - 高性能
  - 支持多种数据结构
  - 可用于队列

### 任务队列

- **Celery**: 分布式任务队列
  - 异步任务处理
  - 定时任务
  - 任务监控

- **RabbitMQ**: 消息代理
  - 可靠的消息传递
  - 支持多种消息模式
  - 高可用性

### 认证与授权

- **JWT**: JSON Web Token 认证
  - 无状态认证
  - 跨域支持
  - 安全可靠

- **RBAC**: 基于角色的访问控制
  - 灵活的权限管理
  - 细粒度权限控制

### 其他工具

- **Alembic**: 数据库迁移工具
- **Pydantic**: 数据验证
- **Uvicorn**: ASGI 服务器
- **Docker**: 容器化部署

## 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      客户端                            │
│              (Web / Mobile / API)                      │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/HTTPS
                     ▼
┌─────────────────────────────────────────────────────────┐
│                   Nginx (可选)                         │
│              反向代理 / 负载均衡                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  FastAPI 应用                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │              中间件层                            │  │
│  │  - CORS                                       │  │
│  │  - 认证中间件                                  │  │
│  │  - 权限中间件                                  │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │              路由层 (Routes)                     │  │
│  │  - 接口定义                                    │  │
│  │  - 参数绑定                                    │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │           控制器层 (Controllers)                │  │
│  │  - 参数验证                                    │  │
│  │  - 业务协调                                    │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │            服务层 (Services)                    │  │
│  │  - 业务逻辑                                    │  │
│  │  - 数据处理                                    │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │            模型层 (Models)                     │  │
│  │  - 数据模型                                    │  │
│  │  - 关系映射                                    │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        ▼            ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│  MySQL   │  │  Redis   │  │ RabbitMQ │
│  主数据库 │  │  缓存    │  │ 消息队列 │
└──────────┘  └──────────┘  └──────────┘
```

## 分层架构

### 1. 路由层 (Routes)

**职责**：

- 定义 API 接口
- 处理 HTTP 请求路由
- 指定请求方法、路径、参数

**特点**：

- 只负责接口定义，不包含业务逻辑
- 使用 FastAPI 装饰器
- 自动生成 OpenAPI 文档

### 2. 控制器层 (Controllers)

**职责**：

- 接收并验证请求参数
- 调用服务层处理业务逻辑
- 返回统一格式的响应

**特点**：

- 轻量级，只做参数验证和业务协调
- 不包含复杂的业务逻辑
- 使用装饰器进行参数验证

### 3. 服务层 (Services)

**职责**：

- 实现核心业务逻辑
- 处理数据库操作
- 协调多个模型的操作

**特点**：

- 包含所有业务逻辑
- 继承 BaseService 获得通用功能
- 可复用性高

### 4. 模型层 (Models)

**职责**：

- 定义数据模型
- 建立数据库表结构
- 定义模型之间的关系

**特点**：

- 使用 SQLModel 定义
- 继承 BaseTableModel
- 支持类型提示和验证

## 数据流转

```
客户端请求
    │
    ▼
┌─────────────┐
│   Routes    │ 1. 接收请求
└──────┬──────┘
       │
       ▼
┌─────────────┐
│Controllers  │ 2. 参数验证
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Services   │ 3. 业务逻辑
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Models    │ 4. 数据操作
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Database   │ 5. 持久化
└─────────────┘
```

## 模块化设计

### 模块划分

项目采用模块化设计，每个功能模块独立：

- **admin**: 管理员管理模块
- **quant**: 量化数据模块
- **common**: 公共模块

### 模块结构

每个模块都遵循统一的结构：

```
Modules/{module_name}/
├── controllers/    # 控制器
├── services/       # 服务
├── models/         # 模型
├── routes/         # 路由
├── validators/     # 验证器
├── middleware/     # 中间件
├── migrations/     # 数据库迁移
├── seeds/         # 数据填充
├── queues/        # 队列
└── tasks/         # 异步任务
```

### 模块独立性

- 模块之间低耦合
- 模块内部高内聚
- 易于维护和扩展

## 配置管理

### 配置系统

使用 Pydantic 进行配置管理：

- 类型安全
- 环境变量支持
- 配置验证
- 默认值支持

### 配置文件

```
config/
├── app.py          # 应用配置
├── database.py     # 数据库配置
├── cache.py        # 缓存配置
├── jwt.py          # JWT 配置
├── log.py          # 日志配置
└── ...
```

## 安全设计

### 认证机制

- JWT Token 认证
- Token 刷新机制
- 密码加密存储

### 权限控制

- RBAC 权限模型
- 中间件权限验证
- 细粒度权限控制

### 数据安全

- SQL 注入防护
- XSS 防护
- CSRF 防护
- 敏感数据加密

## 性能优化

### 缓存策略

- Redis 缓存
- 查询结果缓存
- 会话缓存

### 数据库优化

- 索引优化
- 查询优化
- 连接池管理

### 异步处理

- 异步 I/O
- 异步任务队列
- 并发处理

## 可扩展性

### 水平扩展

- 无状态设计
- 负载均衡
- 分布式部署

### 垂直扩展

- 模块化设计
- 插件机制
- 中间件支持

## 监控与日志

### 日志系统

- 结构化日志
- 日志分级
- 日志轮转

### 监控工具

- 健康检查
- 性能监控
- 错误追踪

## 部署架构

### 开发环境

```
┌─────────────────┐
│  开发者机器     │
│  - FastAPI      │
│  - MySQL        │
│  - Redis        │
└─────────────────┘
```

### 生产环境

```
                    ┌─────────────┐
                    │    Nginx    │
                    │  负载均衡    │
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  Server 1   │   │  Server 2   │   │  Server 3   │
│  - FastAPI  │   │  - FastAPI  │   │  - FastAPI  │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         │
          ┌──────────────┼──────────────┐
          ▼              ▼              ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   MySQL     │  │   Redis     │  │  RabbitMQ   │
│  主从复制    │  │   集群      │  │   集群      │
└─────────────┘  └─────────────┘  └─────────────┘
```

## 设计原则

### 1. 单一职责原则

每个类、函数、模块只负责一项功能。

### 2. 开闭原则

对扩展开放，对修改关闭。

### 3. 依赖倒置原则

依赖抽象，不依赖具体实现。

### 4. 接口隔离原则

使用细粒度的接口，避免臃肿的接口。

### 5. 最小知识原则

模块之间尽量减少交互。

## 技术选型理由

### 为什么选择 FastAPI？

- **高性能**: 基于 Starlette 和 Pydantic，性能接近 Go
- **类型安全**: 完整的类型提示支持
- **自动文档**: 自动生成 OpenAPI 文档
- **异步支持**: 原生支持 async/await
- **易用性**: 简单直观的 API 设计

### 为什么选择 SQLModel？

- **类型安全**: 结合 Pydantic 和 SQLAlchemy
- **减少重复**: 一个模型定义用于验证和数据库
- **易用性**: 简化数据库操作
- **兼容性**: 完全兼容 SQLAlchemy

### 为什么选择 Celery？

- **成熟稳定**: 广泛使用的任务队列
- **功能丰富**: 支持定时任务、链式任务等
- **易于监控**: 提供 Flower 监控工具
- **高可用**: 支持分布式部署

## 未来规划

### 短期目标

- 完善单元测试
- 优化性能
- 增强安全性

### 中期目标

- 微服务化
- 容器化部署
- CI/CD 自动化

### 长期目标

- 多租户支持
- 插件系统
- 云原生架构

## 相关链接

- [分层架构说明](./layered-architecture.md)
- [设计模式应用](./design-patterns.md)
- [最佳实践](./best-practices.md)
- [项目结构说明](../server/project-structure.md)
- [快速开始](../server/getting-started.md)

---

通过理解整体架构，您可以更好地开发和维护项目。
